<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generar Etiqueta - Ben & Frank</title>
<style>
  body { font-family: Arial, sans-serif; margin:18px; background:#f6f6f6; color:#111;}
  .wrap { max-width:820px; margin:0 auto; }
  h1 { text-align:center; margin-bottom:12px; }
  label { display:block; font-weight:700; margin-top:10px; }
  select,input { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #bbb; border-radius:4px; }
  button { margin-top:12px; width:100%; padding:10px; background:#111; color:#fff; border:none; font-weight:700; cursor:pointer; }
  #controls { display:none; margin-top:10px; text-align:center; }
  #controls button { width:48%; display:inline-block; margin-right:4%; }
  #labelPreviewWrap { margin-top:18px; }

  /* etiqueta: dimensiones exactas */
  .label {
    width:4.5cm;
    height:2.8cm;
    box-sizing:border-box;
    border:1px solid #111;
    background:#fff;
    padding:4px 6px;
    position:relative;
    font-size:10px;
  }

  .label .toprow { display:flex; justify-content:space-between; align-items:flex-start; }
  .brand { font-weight:800; font-size:11px; letter-spacing:1px; }
  .consig { font-weight:700; font-size:12px; text-align:center; margin-top:2px; }

  .barcode-wrap { display:flex; justify-content:center; align-items:center; margin-top:2px; }
  .barcode-text { text-align:center; font-size:10px; margin-top:2px; letter-spacing:2px; }

  /* Al imprimir: ocultar todo excepto la etiqueta generada (clonada en la ventana nueva) */
  @media print {
    body * { visibility: hidden !important; }
    .print-only, .print-only * { visibility: visible !important; }
    .print-only { position: absolute; left:0; top:0; width:100%; }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Generar Etiqueta - Ben & Frank</h1>

  <!-- Formulario (igual combinaciones que antes) -->
  <label>Armazón</label>
  <select id="armazon">
    <option value="annie">annie</option>
    <option value="barragan">barragan</option>
    <option value="dafna">dafna</option>
    <option value="bill">bill</option>
    <option value="artigas">artigas</option>
    <option value="dave">dave</option>
  </select>

  <label>Color</label>
  <select id="color"></select>

  <label>Graduación</label>
  <select id="graduacion">
    <option value="monofocal">monofocal</option>
    <option value="progresivo newton">progresivo newton</option>
    <option value="progresivo newton plus">progresivo newton plus</option>
    <option value="sin graduacion">sin graduacion</option>
  </select>

  <label>Cristal</label>
  <select id="cristal">
    <option value="antireflejante verde">antireflejante verde</option>
    <option value="antireflejante azul">antireflejante azul</option>
    <option value="fotocromatico">fotocromatico</option>
  </select>

  <label>Extras</label>
  <select id="extra">
    <option value="-- ninguno --">-- ninguno --</option>
    <option value="hi-index">hi-index</option>
  </select>

  <button id="btnGenerate">Generar Etiqueta</button>

  <!-- Controls que aparecen después -->
  <div id="controls">
    <button id="btnPrint">Imprimir</button>
    <button id="btnSavePDF">Guardar PDF</button>
  </div>

  <!-- Preview -->
  <div id="labelPreviewWrap" aria-live="polite"></div>
</div>

<script>
/* === DATOS === */
const coloresMap = {
  annie: ["rojo","verde"],
  barragan: ["cosmico","azul"],
  dafna: ["nube","cielo","estrellas"],
  bill: ["aguas","fuego"],
  artigas: ["metalico","bronce"],
  dave: ["pomaire","rancagua"]
};

const CONSIGNACION_FIJA = "123456"; // código fijo debajo del barcode

/* rellenar colores */
const armazonEl = document.getElementById('armazon');
const colorEl = document.getElementById('color');
function actualizarColores(){
  const v = armazonEl.value;
  colorEl.innerHTML = '';
  (coloresMap[v]||[]).forEach(c=>{
    const o=document.createElement('option'); o.value=c; o.textContent=c; colorEl.appendChild(o);
  });
}
armazonEl.addEventListener('change', actualizarColores);
actualizarColores();

/* ================= EAN-13: utilidades ================= */

/* calcula dígito verificador EAN-13 para 12 dígitos numéricos (string) */
function calcularCheckDigit(d12){
  // d12: string length 12
  let sum = 0;
  for(let i=0;i<12;i++){
    const n = parseInt(d12.charAt(i),10);
    // posición i from left (0-based). For EAN13 weighting: positions 1..12 (left->right) even positions *3
    // Implementation: if ((i+1)%2==0) multiply by 3
    if(((i+1) % 2) === 0) sum += n * 3;
    else sum += n;
  }
  const mod = sum % 10;
  const check = (10 - mod) % 10;
  return String(check);
}

/* djb2 hash -> numeric, used to create deterministic 12-digit base from combination */
function djb2(str){
  let h = 5381;
  for(let i=0;i<str.length;i++){
    h = ((h << 5) + h) + str.charCodeAt(i); /* h * 33 + c */
    h = h & 0xFFFFFFFF;
  }
  return Math.abs(h);
}

/* genera 12 dígitos a partir de la combinación */
function generar12ParaCombo(comboString){
  const h = djb2(comboString).toString(); // decimal string
  // queremos 12 dígitos: concatenar h y timestamp deterministic? use h repeated then slice
  let s = h;
  while(s.length < 12) s = s + h;
  s = s.slice(0,12);
  return s;
}

/* EAN13 encoding tables */
const A = {
  "0":"0001101","1":"0011001","2":"0010011","3":"0111101","4":"0100011","5":"0110001","6":"0101111","7":"0111011","8":"0110111","9":"0001011"
};
const B = {
  "0":"0100111","1":"0110011","2":"0011011","3":"0100001","4":"0011101","5":"0111001","6":"0000101","7":"0010001","8":"0001001","9":"0010111"
};
const C = {
  "0":"1110010","1":"1100110","2":"1101100","3":"1000010","4":"1011100","5":"1001110","6":"1010000","7":"1000100","8":"1001000","9":"1110100"
};
/* parity patterns for first digit */
const PARITY = {
  "0":"AAAAAA",
  "1":"AABABB",
  "2":"AABBAB",
  "3":"AABBBA",
  "4":"ABAABB",
  "5":"ABBAAB",
  "6":"ABBBAA",
  "7":"ABABAB",
  "8":"ABABBA",
  "9":"ABBABA"
};

/* genera bitstring EAN-13 completo (95 bits) para 13 dígitos (string) */
function ean13Bits(code13){
  // code13 string length 13
  const first = code13.charAt(0);
  const left = code13.slice(1,7);
  const right = code13.slice(7,13);
  const parity = PARITY[first];
  let bits = "101"; // start guard
  for(let i=0;i<6;i++){
    const d = left.charAt(i);
    const p = parity.charAt(i);
    if(p === "A") bits += A[d];
    else bits += B[d];
  }
  bits += "01010"; // center
  for(let i=0;i<6;i++){
    const d = right.charAt(i);
    bits += C[d];
  }
  bits += "101"; // end guard
  return bits; // length 95
}

/* generar SVG a partir de bits, ajustado a 4.5cm width */
function bitsToSVG(bits){
  // SVG width: 4.5cm, height: let's choose 18mm for bars + space for digits
  const svgWidthMM = 45; // 4.5 cm = 45 mm
  const svgHeightMM = 28; // overall label height is 28 mm; use part for barcode
  const barAreaHeight = 12; // mm for bars
  const textY = barAreaHeight + 4; // position for numeric text
  const totalBits = bits.length; // 95
  const unitMM = svgWidthMM / totalBits;
  let x = 0;
  let rects = '';
  for(let i=0;i<bits.length;i++){
    const bit = bits.charAt(i);
    if(bit === '1'){
      // draw bar
      rects += `<rect x="${x.toFixed(4)}mm" y="0mm" width="${unitMM.toFixed(4)}mm" height="${barAreaHeight}mm" fill="#000"/>`;
    }
    x += unitMM;
  }
  // return svg markup (we will add digits separately outside)
  return {
    svg:`<svg xmlns="http://www.w3.org/2000/svg" width="${svgWidthMM}mm" height="${barAreaHeight+2}mm" viewBox="0 0 ${svgWidthMM} ${barAreaHeight+2}">${rects}</svg>`,
    unitMM
  };
}

/* genera código EAN-13 (13 dígitos string) determinístico por combinación */
function generarEAN13ParaCombo(combo){
  const base12 = generar12ParaCombo(combo); // 12 digits
  const check = calcularCheckDigit(base12);
  return base12 + check;
}

/* ================= UI: generar etiqueta y mostrar preview ================= */

const btnGenerate = document.getElementById('btnGenerate');
const previewWrap = document.getElementById('labelPreviewWrap');
const controls = document.getElementById('controls');
const btnPrint = document.getElementById('btnPrint');
const btnSavePDF = document.getElementById('btnSavePDF');

btnGenerate.addEventListener('click', ()=> {
  const armazon = document.getElementById('armazon').value;
  const color = document.getElementById('color').value;
  const grad = document.getElementById('graduacion').value;
  const cristal = document.getElementById('cristal').value;
  const extra = document.getElementById('extra').value;

  const comboStr = `${armazon}|${color}|${grad}|${cristal}|${extra}`;
  const ean13 = generarEAN13ParaCombo(comboStr);

  // generar bits y svg
  const bits = ean13Bits(ean13);
  const svgData = bitsToSVG(bits);

  // crear markup de la etiqueta (exact size 4.5cm x 2.8cm)
  const labelHtml = `
    <div class="label print-only" id="labelParaImprimir" role="region" aria-label="Etiqueta">
      <div class="toprow">
        <div class="brand">BEN & FRANK</div>
        <div style="font-size:10px; text-align:right;">${CONSIGNACION_FIJA}</div>
      </div>

      <div class="barcode-wrap" style="margin-top:4px;">
        ${svgData.svg}
      </div>

      <div class="barcode-text">${ean13}</div>

      <div class="consig">Consignación: ${CONSIGNACION_FIJA}</div>
    </div>
  `;

  previewWrap.innerHTML = labelHtml;

  // show controls
  controls.style.display = 'block';

  // scroll into view
  setTimeout(()=> {
    const el = document.getElementById('labelParaImprimir');
    if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
  }, 120);
});

/* Imprimir: abrir ventana nueva con solo la etiqueta y llamar print */
btnPrint.addEventListener('click', ()=> {
  const label = document.getElementById('labelParaImprimir');
  if(!label){ alert('Primero genera la etiqueta.'); return; }
  const w = window.open('','_blank');
  if(!w){ alert('Permite popups para imprimir.'); return; }

  const css = `
    <style>
      body{ margin:0; padding:6px; background:#fff; display:flex; align-items:flex-start; height:100vh; }
      .label{ width:4.5cm; height:2.8cm; border:1px solid #111; padding:4px 6px; box-sizing:border-box; font-family:Arial, sans-serif; font-size:10px; }
      .barcode-text{ text-align:center; font-size:9px; margin-top:2px; letter-spacing:1.5px; }
      .consig{ text-align:center; font-weight:700; font-size:10px; margin-top:3px; }
      svg{ display:block; margin:0 auto; }
    </style>
  `;
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Imprimir etiqueta</title>${css}</head><body>`);
  w.document.write(document.getElementById('labelParaImprimir').outerHTML);
  w.document.write('</body></html>');
  w.document.close();

  setTimeout(()=>{
    try{
      w.focus();
      w.print();
    }catch(e){
      alert('Error al imprimir: usa la ventana nueva para imprimir manualmente.');
    }
  },300);
});

/* Guardar PDF -> reusa imprimir (usuario elige "Guardar como PDF") */
btnSavePDF.addEventListener('click', ()=> {
  btnPrint.click();
});

/* Optional: allow clicking label to download svg image (not required) */
// previewWrap.addEventListener('click', (e)=>{ /* could implement save */ });

</script>
</body>
</html>
